<!doctype html>
<html lang="en">
 <head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="../main.css">
 </head>
 <body>
  <div id="readme" class="Box">
   <article class="markdown-body container-lg">
    <h1>Customizing code generation</h1>
    <p>You can customize code generation by <strong>Translator</strong> interface.</p>
    <h2>Translator interface</h2>
    <table>
     <thead>
      <tr>
       <th>function</th>
       <th>description</th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>escape</td>
       <td>Escape characters</td>
      </tr>
      <tr>
       <td>format</td>
       <td>Format message</td>
      </tr>
      <tr>
       <td>getSubject</td>
       <td>Get subject from message</td>
      </tr>
      <tr>
       <td>getScreenNickName</td>
       <td>Get screen nickname from message</td>
      </tr>
      <tr>
       <td>conditionMessageToFunction</td>
       <td>Convert expectation message to function string</td>
      </tr>
      <tr>
       <td>actionMessageToFunction</td>
       <td>Convert expectation message to function string</td>
      </tr>
      <tr>
       <td>targetToFunction</td>
       <td>Convert target to function string</td>
      </tr>
      <tr>
       <td>expectationMessageToFunction</td>
       <td>Convert expectation message to function string</td>
      </tr>
      <tr>
       <td>atEndOfScenario</td>
       <td>Extension point called after scenario lines generated</td>
      </tr>
      <tr>
       <td>atEndOfCase</td>
       <td>Extension point called after case lines generated</td>
      </tr>
      <tr>
       <td>atEndOfCondition</td>
       <td>Extension point called after condition lines generated</td>
      </tr>
      <tr>
       <td>atEndOfAction</td>
       <td>Extension point called after action lines generated</td>
      </tr>
      <tr>
       <td>atEndOfExpectation</td>
       <td>Extension point called after expectation lines generated</td>
      </tr>
      <tr>
       <td>atEndOfTarget</td>
       <td>Extension point called after target lines generated</td>
      </tr>
     </tbody>
    </table>
    <h3>Translator.kt</h3>
    <pre><code class="language-kotlin">package shirates.spec.code.custom

import shirates.core.configuration.PropertiesManager
import shirates.spec.code.entity.Case
import shirates.spec.code.entity.Target
import shirates.spec.utilily.*

interface Translator {

    /**
     * escape
     */
    fun escape(message: String): String {

        if (PropertiesManager.logLanguage == "ja") {
            return message.replace("\\", "¥")
        } else {
            return message.replace("\\", "\\\\")
        }
    }

    /**
     * format
     */
    fun format(message: String): String {

        var msg = escape(message)
        msg = msg.removePrefix(SpecResourceUtility.bullet).removeBrackets().removeJapaneseBrackets()
        return msg
    }

    /**
     * getSubject
     */
    fun getSubject(message: String): String {

        val screenNickname = getScreenNickName(message = message)
        if (screenNickname.isNotBlank()) {
            return screenNickname
        }

        val nickname1 = message.getGroupValue(".*(\\[.*]).*".toRegex())
        if (nickname1.isNotBlank()) {
            return nickname1
        }

        val nickname2 = message.getGroupValue(".*(\\{.*}).*".toRegex())
        if (nickname2.isNotBlank()) {
            return nickname2
        }

        val selectorExpression = message.getGroupValue(".*(&lt;.*&gt;).*".toRegex())
        if (selectorExpression.isNotBlank()) {
            return selectorExpression
        }

        if (message.contains("を")) {
            val list = message.split("を").toMutableList()
            list.removeLast()
            val s = format(list.joinToString())
            return "&lt;$s&gt;"
        }

        return ""
    }

    /**
     * getScreenNickName
     */
    fun getScreenNickName(
        message: String
    ): String {

        val replaced = message.removeJapaneseBrackets().removeBrackets()
        for (keyword in Keywords.screenKeywords) {
            val screenName = replaced.getGroupValue(".*(\\.*$keyword.*).*".toRegex())
            if (screenName.isNotBlank()) {
                return "[$screenName]"
            }
        }

        return ""
    }

    /**
     * messageToFunction
     */
    fun messageToFunction(message: String, defaultFunc: String = "manual"): String {

        val subject = getSubject(message)

        if (subject.isNotBlank()) {
            if (message.isDisplayed) {
                if (subject.isScreen) {
                    return "screenIs(\"$subject\")"
                } else {
                    if (message.isAssertion) {
                        return "exist(\"${subject}\")"
                    }
                    return "manual(\"$message\")"
                }
            }
            if (message.contains("アイコンをタップする") || message.lowercase().contains("tap app icon")) {
                return "tapAppIcon(\"$subject\")"
            }
            if (message.contains("タップする") || message.lowercase().contains("tap ")) {
                return "tap(\"$subject\")"
            }
            if (message.contains("がON") || message.lowercase().endsWith(" is on")) {
                return "select(\"$subject\").checkIsON()"
            }
            if (message.contains("がOFF") || message.lowercase().endsWith(" is off")) {
                return "select(\"$subject\").checkIsOFF()"
            }

            if (message.isAssertion) {
                val valueEN = message.getGroupValue(".* is \"(.*)\"".toRegex())
                if (valueEN.isNotBlank()) {
                    return "select(\"$subject\").textIs(\"$valueEN\")"
                }
                val valueJP = message.getGroupValue(".*の値が\"(.*)\"であること.*".toRegex())
                if (valueJP.isNotBlank()) {
                    return "select(\"$subject\").textIs(\"$valueJP\")"
                }
            }
        }

        val arg = format(message)
        return "$defaultFunc(\"$arg\")"
    }

    /**
     * conditionMessageToFunction
     */
    fun conditionMessageToFunction(
        case: Case,
        message: String,
        defaultFunc: String = "manual"
    ): String {

        if (message.startsWith("[") &amp;&amp; message.endsWith("]")) {
            return "macro(\"$message\")"
        }

        val screenNickname = getScreenNickName(message = message)
        if (screenNickname.isNotBlank()) {
            return "macro(\"$screenNickname\")"
        }

        return messageToFunction(message = message, defaultFunc = defaultFunc)
    }

    /**
     * actionMessageToFunction
     */
    fun actionMessageToFunction(
        case: Case,
        message: String,
        defaultFunc: String = "manual"
    ): String {

        return messageToFunction(message = message, defaultFunc = defaultFunc)
    }

    /**
     * targetToFunction
     */
    fun targetToFunction(
        target: String
    ): String {

        val screenNickName = getScreenNickName(message = target)
        if (screenNickName.isNotBlank()) {
            return "it.target(\"$screenNickName\")"
        }

        val escaped = escape(target.replace("\n", ""))
        return "it.target(\"$escaped\")"
    }

    /**
     * expectationMessageToFunction
     */
    fun expectationMessageToFunction(
        target: Target? = null,
        message: String,
        defaultFunc: String = "manual"
    ): String {

        if (target?.target != null) {
            if (message.isDisplayed) {
                if (target.target.isScreen) {
                    val screenNickName = getScreenNickName(target.target)
                    return "screenIs(\"$screenNickName\")"
                } else {
                    if (message.isAssertion) {
                        return "exist(\"${target.target}\")"
                    }
                    return "manual(\"$message\")"
                }
            }
            val functionPart = messageToFunction(message = message, defaultFunc = defaultFunc)
            if (functionPart.isNotBlank()) {
                return functionPart
            }
        }

        val arg = format(message)
        return "$defaultFunc(\"$arg\")"
    }

    /**
     * atEndOfScenario
     */
    fun atEndOfScenario(lines: MutableList&lt;String&gt;) {

    }

    /**
     * atEndOfCase
     */
    fun atEndOfCase(lines: MutableList&lt;String&gt;) {

    }

    /**
     * atEndOfCondition
     */
    fun atEndOfCondition(lines: MutableList&lt;String&gt;) {

    }

    /**
     * atEndOfAction
     */
    fun atEndOfAction(lines: MutableList&lt;String&gt;) {

    }

    /**
     * atEndOfExpectation
     */
    fun atEndOfExpectation(lines: MutableList&lt;String&gt;) {

    }

    /**
     * atEndOfTarget
     */
    fun atEndOfTarget(lines: MutableList&lt;String&gt;) {

        // Remove `target` if `screenIs` succeeds
        if (lines.count() &gt;= 2 &amp;&amp; lines[1].startsWith("it.screenIs(")) {
            if (lines[0].startsWith("it.target(")) {
                lines.removeAt(0)
            }
        }

        for ((i, line) in lines.withIndex()) {
            if (i &gt; 0) {
                if (lines[i - 1].endsWith("{").not())
                    lines[i] = line.removePrefix("it")
            }
        }
    }

}
</code></pre>
    <h2>Example</h2>
    <ol>
     <li>Run <code>AndroidSettingdDemo</code> to get <strong>Spec-Report</strong> (<code>AndroidSettingsDemo@a.xlsx</code>). ( See <a href="../quick-start.html">Quick start</a>)</li>
     <li>Create <code>SpecInput</code> directory in <code>Downloads</code> directory, put <code>AndroidSettingsDemo@a.xlsx</code> in it.</li>
     <li>Run <code>CodeGeneratorExecute</code> to get <code>AndroidSettingsDemo.kt</code>.</li>
    </ol>
    <h3>AndroidSettingsDemo.kt</h3>
    <pre><code class="language-kotlin">package generated

import org.junit.jupiter.api.DisplayName
import org.junit.jupiter.api.Test
import shirates.core.configuration.Testrun
import shirates.core.driver.branchextension.*
import shirates.core.driver.commandextension.*
import shirates.core.testcode.*

@SheetName("AndroidSettingsDemo")
class AndroidSettingsDemo : UITest() {

    @NoLoadRun
    @Test
    @DisplayName("airplaneModeSwitch()")
    fun S1010() {

        scenario {
            case(1) {
                condition {
                    it.manual("Tap app icon &lt;Settings&gt;")
                        .screenIs("[Android Settings Top Screen]")
                }.action {
                    it.manual("Tap [Network &amp; internet]")
                }.expectation {
                    it.screenIs("[Network &amp; internet Screen]")
                }
            }
            case(2) {
                condition {
                    it.manual("{Airplane mode switch} is OFF")
                }.action {
                    it.manual("Tap {Airplane mode switch}")
                }.expectation {
                    it.manual("{Airplane mode switch} is ON")
                }
            }
            case(3) {
                action {
                    it.manual("Tap {Airplane mode switch}")
                }.expectation {
                    it.manual("{Airplane mode switch} is OFF")
                }
            }
        }
    }

}
</code></pre>
    <ol>
     <li>Create <code>CustomTranslator.kt</code> in <code>kotlin/exercise</code>.</li>
    </ol>
    <h4>CustomTranslator.kt</h4>
    <pre><code class="language-kotlin">package exercise

object CustomTranslator {

}
</code></pre>
    <ol>
     <li>Edit as follows. 
      <ol>
       <li>Annotate <code>CustomTranslator</code> with <code>@CustomObject</code>.</li>
       <li>Inherit from Translator interface.</li>
       <li>Override <code>actionMessageToFunction</code> function and annotate it with <code>@CustomFunction</code>.</li>
       <li>Implement custom translation logic. In this example, tap function is output if the message has ‘tap’ and nickname.</li>
      </ol></li>
    </ol>
    <pre><code class="language-kotlin">package exercise

import shirates.core.customobject.CustomFunction
import shirates.core.customobject.CustomObject
import shirates.spec.code.custom.Translator
import shirates.spec.code.entity.Case

@CustomObject
object CustomTranslator : Translator {

    @CustomFunction
    override fun actionMessageToFunction(case: Case, message: String, defaultFunc: String): String {

        val nickname = getNickName(message)
        if (message.lowercase().contains("tap") &amp;&amp; nickname.isNotBlank()) {
            return "tap(\"$nickname\")"
        }

        return super.actionMessageToFunction(case, message, defaultFunc)
    }

}
</code></pre>
    <ol>
     <li>Build the project.</li>
     <li>Run <code>CodeGeneratorExecute</code> to get <code>AndroidSettingsDemo.kt</code>. You can get output as follows.</li>
    </ol>
    <pre><code class="language-kotlin">case(1) {
    condition {
        it.manual("Tap app icon &lt;Settings&gt;")
            .screenIs("[Android Settings Top Screen]")
    }.action {
        it.tap("[Network &amp; internet]")
    }.expectation {
        it.target("[Network &amp; internet Screen]")
        android {
            specialTag(specialTag = "osaifu") {
                it.screenIs("[Network &amp; internet Screen]")
            }
        }
    }
}
</code></pre>
    <p><strong>Before</strong></p>
    <pre><code class="language-kotlin">it.manual("Tap [Network &amp; internet]")
</code></pre>
    <p><strong>After</strong></p>
    <pre><code class="language-kotlin">it.tap("[Network &amp; internet]")
</code></pre>
    <h3>Link</h3>
    <ul>
     <li><a href="../index.html">index</a></li>
    </ul>
   </article>
  </div>
 </body>
</html>